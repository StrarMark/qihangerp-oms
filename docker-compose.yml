version: '3.8'

services:
  redis:
    image: redis:7
    container_name: redis
    ports:
      - "6379:6379"  # 映射6379端口
    command: ["redis-server"]  # 允许所有IP访问
    volumes:
      - redis_data:/data
    restart: always
    networks:
      - my-network

  nacos:
    image: nacos/nacos-server:v2.3.2
    container_name: nacos
    environment:
      MODE: standalone  # 单机模式
      NACOS_AUTH_ENABLED: "false"  # 禁用认证
    ports:
      - "8848:8848"
      - "9848:9848"
    restart: always
    volumes:
      - nacos_data:/home/nacos/data
    networks:
      - my-network  # 自定义网络
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8848/nacos/v1/ns/operator/servers"]
      interval: 10s
      retries: 5
      start_period: 20s
      timeout: 5s

  gateway:
    image: crpi-km68smz26eegv27m.cn-shenzhen.personal.cr.aliyuncs.com/qihang-open/gateway
    container_name: qihangerp-gateway
    environment:
      SPRING_CLOUD_NACOS_DISCOVERY_SERVER-ADDR: "nacos:8848"
      SPRING_CLOUD_NACOS_DISCOVERY_USERNAME: "nacos"
      SPRING_CLOUD_NACOS_DISCOVERY_PASSWORD: "nacos"
    ports:
      - "8088:8088"
    depends_on:
      - redis
      - nacos
    restart: always
    networks:
      - my-network

  sys-api:
    image: crpi-km68smz26eegv27m.cn-shenzhen.personal.cr.aliyuncs.com/qihang-open/sys-api
    container_name: qihangerp-sys-api
    environment:
      SPRING_CLOUD_NACOS_DISCOVERY_SERVER-ADDR: "nacos:8848"
      SPRING_CLOUD_NACOS_DISCOVERY_USERNAME: "nacos"
      SPRING_CLOUD_NACOS_DISCOVERY_PASSWORD: "nacos"
      SPRING_CLOUD_NACOS_CONFIG_SERVER-ADDR: "nacos:8848"
      SPRING_CLOUD_NACOS_CONFIG_USERNAME: "nacos"
      SPRING_CLOUD_NACOS_CONFIG_PASSWORD: "nacos"
      spring.data.redis.host: "redis"
      spring.data.redis.port: 6379
      spring.data.redis.password: ""
      spring.profiles.active: dev
    depends_on:
      - redis
      - nacos
    restart: always
    networks:
      - my-network

  oms-api:
    image: crpi-km68smz26eegv27m.cn-shenzhen.personal.cr.aliyuncs.com/qihang-open/oms-api
    container_name: qihangerp-oms-api
    environment:
      SPRING_CLOUD_NACOS_DISCOVERY_SERVER-ADDR: "nacos:8848"
      SPRING_CLOUD_NACOS_DISCOVERY_USERNAME: "nacos"
      SPRING_CLOUD_NACOS_DISCOVERY_PASSWORD: "nacos"
      SPRING_CLOUD_NACOS_CONFIG_SERVER-ADDR: "nacos:8848"
      SPRING_CLOUD_NACOS_CONFIG_USERNAME: "nacos"
      SPRING_CLOUD_NACOS_CONFIG_PASSWORD: "nacos"
      spring.data.redis.host: "redis"
      spring.data.redis.port: 6379
      spring.data.redis.password: ""
      spring.profiles.active: dev
    depends_on:
      - redis
      - nacos
    restart: always
    networks:
      - my-network

  erp-api:
    image: crpi-km68smz26eegv27m.cn-shenzhen.personal.cr.aliyuncs.com/qihang-open/erp-api
    container_name: qihangerp-erp-api
    environment:
      SPRING_CLOUD_NACOS_DISCOVERY_SERVER-ADDR: "nacos:8848"
      SPRING_CLOUD_NACOS_DISCOVERY_USERNAME: "nacos"
      SPRING_CLOUD_NACOS_DISCOVERY_PASSWORD: "nacos"
      SPRING_CLOUD_NACOS_CONFIG_SERVER-ADDR: "nacos:8848"
      SPRING_CLOUD_NACOS_CONFIG_USERNAME: "nacos"
      SPRING_CLOUD_NACOS_CONFIG_PASSWORD: "nacos"
      spring.data.redis.host: "redis"
      spring.data.redis.port: 6379
      spring.data.redis.password: ""
      spring.profiles.active: dev
    depends_on:
      - redis
      - nacos
    restart: always
    networks:
      - my-network

  vue:
    image: crpi-km68smz26eegv27m.cn-shenzhen.personal.cr.aliyuncs.com/qihang-open/vue-erp
    container_name: qihangerp-vue
    ports:
      - "80:80"  # 映射88端口
      - "443:443"  # 映射88端口
#    volumes:
#      - /opt/qihangerp/nginx/dist:/usr/share/nginx/html  # HTML 文件目录
#      - /opt/qihangerp/nginx/nginx_conf/nginx:/etc/nginx  # Nginx 配置目录
#      - /opt/qihangerp/nginx/nginx_logs:/var/log/nginx  # Nginx 日志目录
    networks:
      - my-network  # 使用 my-network 网络
    restart: always  # 容器崩溃后自动重启


volumes:
  redis_data:  # 定义持久化数据卷
  nacos_data:
networks:
  my-network:
    driver: bridge